#!/usr/bin/env bash

cd $(dirname $0)/../
source settings.conf

rm docroot
if [ -d "docroot" ];
then
  rm -rf docroot
fi

echo 'Running wget for dev-make-output'
wget https://github.com/gsbitse/gsb-build-dev-make-output/raw/master/gsbpublic.tar.gz

echo pwd

echo 'Untarring gsbpublic'
tar -xzf gsbpublic.tar.gz

echo 'Creating docroot'
mv gsbpublic/docroot docroot

echo 'Removing gsbpublic'
rm -rf gsbpublic

echo 'Starting sql-dump'
$DRUSH_PATH --alias-path="./" @gsbpublic.test sql-dump --structure-tables-list="cache,cache_*,history,search_*,sessions,watchdog" | gzip > .snapshot.sql.gz

echo 'Calling build'
build

echo 'Calling import'
import

# Update site variables
echo "Updating the site modules and variables"
drush en -y stage_file_proxy
drush vset stage_file_proxy_origin http://public2-stage.gsb.stanford.edu
drush dis -y memcache_admin acquia_purge acquia_agent shield
drush vset cache 0
drush vset preprocess_css 0
drush vset preprocess_js 0
drush upwd admin --password=admin
drush vd
drush cc all